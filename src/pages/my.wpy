<style lang="less">
@import '../static/style/cardComItem.less';
@import '../static/style/tabCom.less';
.page-my {
  padding: 0 38rpx;
  .my-tool {
    display: flex;
    justify-content: space-around;
    align-items: center;
    margin-bottom: 25rpx;
    margin-top: 30rpx;
  }
  .tool-item {
    width: 16.66%;
    height: 98rpx;
    background-color: #4a668f;
    font-size: 20rpx;
    line-height: 34rpx;
    display: flex;
    flex-direction: column;
    align-items: center;
    box-sizing: border-box;
    justify-content: flex-end;
    // border-right: 1px solid #052941;
    color: #fff;
    position: relative;
    image {
      width: 40rpx;
      height: 40rpx;
      display: block;
      margin-bottom: 4rpx;
    }
    view {
      margin-bottom: 6rpx;
    }
    &:after {
      content: '';
      width: 2rpx;
      height: 64rpx;
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      right: 0;
      display: block;
      background-size: auto 64rpx;
      background-repeat: no-repeat;
      background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAQAAABACAMAAAAK5iY2AAAA/1BMVEUAJTwfXIE3jb43jb4AJTw3jb4AJTw3jb4AJTwAJTw3jb4AJTw3jb4AJTw3jb43jb4AJTwAJTw3jb43jb4AJTw3jb4AJTwAJTw3jb4AJTwAJTw3jb4AJTw3jb4AJTw3jb4AJTw3jb4AJTw3jb4AJTw3jb43jb4AJTw3jb43jb43jb4AJTwAJTw3jb43jb4AJTwAJTwAJTwAJTw3jb4AJTw3jb43jb4AJTw3jb43jb4AJTw3jb4AJTw3jb4AJTw3jb4AJTwAJTw3jb43jb4AJTw3jb43jb4AJTw3jb43jb4AJTwAJTw3jb43jb4AJTwAJTwAJTw3jb43jb43jb43jb5B6p1IAAAAVXRSTlP8Av758+fn4ODY0dHIyL+2tqSjkI+Hh31paVFMQzo6KiojIxQUDgkJ8ez17+zZ18G9r6upnpyYlXt0dHFxYWFeXlhXVEpFQjQzMTEdHBoaDw2vrn9+CvybNAAAAOlJREFUGNMtUFUSwkAMfTjFXUpxCi3u7m4V5P5nYWdDPjKTSfIMFlbUqtVaDbJsGCiXKxU8n48HisVSCfl8oYDr9XJBNpvL4XSSJGQyooj9frfDarVeI5VKpzGbzef4fpJJxOOJBKLRWAyj0XCISCQcxuvd6yEYDIUQCHQ68Pn8fng8Xi9aLUGAy+V2w+FwOqEqjQbqdbsdNhsAq/XfaFQUtlDVZpMf01u7LQgcioMy+G6XiAaDfp/Ix+PJhAsiadMpE7lYLJckfLPZbnE4iCKzdTzifJYksnq73e/cPgWhabpO4ciyafLAfg+MIQhagFwGAAAAAElFTkSuQmCC');
    }
  }
  .my-info {
    display: flex;
    justify-content: space-between;
    padding-top: 30rpx;
    position: relative;
    .name-box {
      min-width: 160rpx;
      height: 44rpx;
      background-image: url('http://s29.9956.cn/res/zhushou/danye/topking/btn1.png');
      background-size: 100% 100%;
      font-size: 20rpx;
      color: #b7e3f6;
      line-height: 44rpx;
      text-align: center;
    }
    .lf {
      width: 166rpx;
      image {
        width: 144rpx;
        height: 144rpx;
        margin-bottom: 20rpx;
        border-radius: 50%;
        border: 2rpx solid #4d9ed4;
      }
    }
    .rt {
      width: 454rpx;
    }
    .rt-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      color: #f1f4ba;
      font-size: 30rpx;
      height: 34rpx;
      .top-lf {
        display: flex;
        align-items: center;
      }
    }
    .rt-mid {
      line-height: 68rpx;
      color: #b7e3f6;
      font-size: 24rpx;
    }
    .rt-btm {
      position: relative;
    }
    .btm-box {
      width: 244rpx;
      max-width: 260rpx;
      height: 50rpx;
      display: flex;
      align-items: center;
      background-image: url('http://s29.9956.cn/res/zhushou/danye/topking/btn2.png');
      background-size: cover;
      font-size: 20rpx;
      color: #b7e3f6;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .my-title {
      position: absolute;
      right: 0;
      bottom: 0;
      height: 46rpx;
      line-height: 46rpx;
      color: #b7e3f6;
      font-size: 24rpx;
      padding-right: 25rpx;
      &::after {
        content: '';
        position: absolute;
        width: 15rpx;
        height: 15rpx;
        border-top: 1rpx solid #b7e3f6;
        border-right: 1rpx solid #b7e3f6;
        transform: rotateZ(45deg);
        right: 0;
        top: 15rpx;
      }
    }
    .up-level {
      position: absolute;
      right: 0;
      top: 15rpx;
      padding: 15rpx;
    }
  }
  .tab-wrap {
    border: 1px solid #85d1ea;
    height: 824rpx;
    box-shadow: inset 0 0 10rpx 3rpx #405784;
    background-color: #475881;
    .content {
      display: flex;
      justify-content: space-between;
      flex-wrap: wrap;
      align-items: center;
      text-align: center;
      padding: 56rpx 66rpx;
    }
  }
  .score-pop-wrap {
    .bg {
      position: fixed;
      top: 0;
      right: 0;
      left: 0;
      bottom: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.4);
      z-index: 99;
    }
    .pop-cont {
      position: fixed;
      top: 50%;
      transform: translateY(-50%);
      left: 0;
      right: 0;
      margin: 0 auto;
      width: 500rpx;
      height: 600rpx;
      background-color: #4b98ec;
      z-index: 100;
    }
    .close {
      position: absolute;
      right: 0;
      top: 0;
      width: 52rpx;
      height: 52rpx;
    }
    .row-wrap {
      display: flex;
      justify-content: space-around;
      align-items: center;
      height: 50rpx;
      .item {
        width: 33.3%;
        color: #b7e3f6;
        font-size: 24rpx;
        align-self: center;
        text-align: center;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
    }
    .row-title {
      margin-top: 38rpx;
      .item {
        color: #f1f4ba;
        font-size: 24rpx;
      }
    }
    .more {
      color: #f1f4ba;
      font-size: 24rpx;
      text-align: center;
      line-height: 80rpx;
      margin-top: 10rpx;
    }
  }
  .bag-btm{
    line-height:58rpx;
    background-color: #1b4f81;

  }
}
</style>
<template>
  <view class="page-my">
       <view class="my-info">
          <view class="lf">
            <image src="{{heroInfo.HeadImg}}" mode="scaleToFill" />
          <view class="name-box">{{heroInfo.Level}}</view>          
          </view>
          <view class="rt">
            <view class="rt-top">
            <view class="top-lf">
            <input  wx:if="{{isEditName}}" bindblur="handleBlur" value="{{heroInfo.UserName}}" focus="focus" placeholder="输入用户名"/>
            <view wx:else>
            <text>{{heroInfo.UserName}}</text>
            <!-- <image @tap="handleEditName" src="../static/img/my/edit.png" mode="aspectFit" style="width:30rpx;height:30rpx;margin-left:30rpx;"/> -->
            </view>
            </view>
            <view class="up-level" @tap="handleJump('/pages/my/uplevel')"><image  src="../static/img/my/15.png" mode="scaleToFill" style="width:30rpx;height:30rpx;"/></view>
            </view>
            <view class="rt-mid" >{{heroInfo.Title?('称号：'+heroInfo.Title):''}}</view>
            <view class="rt-btm" >
              <view @tap="handleJump('/pages/my/bonus')" class="btm-box" style="margin-top:20rpx;margin-bottom:24rpx">
                 <image src="../static/img/my/11.png" mode="aspectFit" style="width:30rpx;height:30rpx;margin:0 15rpx 0 20rpx;"/>
                <view>积分：{{heroInfo.Point}}</view>
                </view>
              <view class="btm-box">
                 <image src="../static/img/my/12.png" mode="aspectFit" style="width:30rpx;height:30rpx;margin:0 15rpx 0 20rpx;"/>
                <view>战斗值：{{heroInfo.Power}}</view>
                </view>
              <view class="my-title" @tap="handleJump('/pages/my/title')">查看我的称号</view>
            </view>
          </view>
      </view>
      <view class="my-tool">
          <view class="tool-item">
            <image src="../static/img/my/1.png" mode="aspectFit"/>
            <view class="txt">背包</view>
          </view>
           <view class="tool-item" @tap="handleJump('/pages/my/npc')">
            <image src="../static/img/my/2.png" mode="aspectFit"/>
            <view class="txt">NPC</view>
          </view>
           <view class="tool-item" @tap="handleJump('/pages/my/message')">
            <image src="../static/img/my/3.png" mode="aspectFit"/>
            <view class="txt">留言</view>
          </view>
           <view class="tool-item" @tap="handleShowPop">
            <image src="../static/img/my/4.png" mode="aspectFit"/>
            <view class="txt">战绩</view>
          </view>
           <view class="tool-item" @tap="handleJump('/pages/my/gift')">
            <image src="../static/img/my/5.png" mode="aspectFit"/>
            <view class="txt">礼包</view>
          </view>
           <view class="tool-item" @tap="handleJumpMall">
            <image src="../static/img/my/6.png" mode="aspectFit"/>
            <view class="txt">商城</view>
          </view>
      </view>
      <view class="tab-wrap">
        <view class="tab-com">
           <repeat for="{{tabArr}}" key="index" index="index" item="item">
             <view style="width:33.3%" class="{{item.t_active==1?'active':''}}" @tap="handleClickTab('{{index}}')">{{item.t_name}}</view>
            </repeat>
        </view>
        <view class="content">
          <repeat for="{{contList}}" key="index" index="index" item="item">
            <view class="{{item.Status?'card-com-item used':'card-com-item'}}">
             <view class="txt">
                      <view class="top">{{item.PrdtName}}</view>
                      <image class="mid" src="{{imgHost+item.PrdtPic}}" mode="aspectFit" style="width:96rpx;height:96rpx"/>
                      <view class="btm bag-btm">{{item.LastDate}}</view>
               </view>
              </view>
            </repeat>
        </view>
      </view>
      <view class="score-pop-wrap" catchtouchmove="preventTouchMove" style="display:{{isShowPop?'block':'none'}}">
         <view class="bg"></view>
         <view class="pop-cont">
         <image class="mid" src="../static/img/my/score-titl.png" mode="aspectFit" style="width:500rpx;height:91rpx"/>
         <view class="row-wrap row-title">
               <view class="item">事件</view>
               <view class="item">获得战力数</view>
               <view class="item">时间</view>
              </view>
          <view style="height:300rpx;overflow:hidden">
          <repeat for="{{scoreList}}" key="index" index="index" item="item">
             <view class="row-wrap">
               <view class="item">{{item.Info}}</view>
               <view class="item">{{item.Power}}</view>
               <view class="item">{{item.CreateDate}}</view>
              </view>
          </repeat>
          </view>
          <view class="more" @tap="handleJumpRecord" wx:if="{{scoreList.length==6}}">查看更多</view>
          <view class="close" @tap="handleClose"></view>
          </view>
          
      </view>
  </view>
</template>

<script>
import wepy from 'wepy';
import wxRequest from '../util/wxRequest.js';

export default class pageMy extends wepy.page {
  config = {
    navigationBarTitleText: '我的',
    enablePullDownRefresh:true,
  };
  components = {};
  data = {
    isShowPop: false,
    isEditName: false,
    tabArr: [
      { t_name: '全部', t_value: '-1', t_active: 1 },
      { t_name: '已使用', t_value: '1', t_active: 0 },
      { t_name: '未使用', t_value: '0', t_active: 0 }
    ],
    contList: [],
    scoreList: [],
    activeStatus:'-1'
  };

  computed = {
    heroInfo(){
      return  this.$parent.globalData.HeroInfo;
    },
    imgHost(){
        return this.$parent.globalData.imgHost
    },
  };

  methods = {
    handleBlur(ev) {
      wx.showLoading({
        title: '加载中'
      });
      setTimeout(() => {
        wx.hideLoading();
        this.isEditName = false;
        this.bindKeyInput = ev.detail.value;
        this.$apply();
        wx.showToast({
          title: '修改成功',
          icon: 'success',
          duration: 2000
        });
      }, 2000);
    },
    handleEditName() {
      this.isEditName = true;
    },
    handleShowPop() {
      this.isShowPop = true;
    },
    handleClose() {
      this.isShowPop = false;
    },
    handleJumpRecord() {
      this.$navigate('/pages/my/record?id='+this.heroInfo.Id);
    },
    handleClickTab(inx) {
      this.tabArr.map((item, index) => {
        index == inx ? (item.t_active = 1) : (item.t_active = 0);
      });
      this.activeStatus=this.tabArr[inx].t_value;
      this.getUserProduct();
    },
    handleJumpMall() {
      wx.switchTab({
        url: '/pages/mall'
      });
    },
    handleJump(path) {
      this.$navigate(path);
    }
  };
//下拉刷新
  onPullDownRefresh(){
     this.getUserPower();
     this.getUserProduct()
     setTimeout(() => {
         wx.stopPullDownRefresh()
       }, 1000);
  }
  events = {};
  //最近战绩
   async getUserPower() {
    const that = this;
    const res = await wxRequest({
      query:{
        opt: 'getUserPower',
        Userid:that.heroInfo.Id,
        num:6,
      }
      },that.$parent.globalData.apiUrl);
   if (res.data.retcode == 0) {
     this.scoreList=res.data.result;
    }
    this.$apply()
  };
  async getUserProduct() {
    const that = this;
    const res = await wxRequest({
      query:{
        opt: 'getUserProduct',
        userid:that.heroInfo.Id,
        status:that.activeStatus
      }
      },that.$parent.globalData.apiUrl);
   if (res.data.retcode == 0) {
       this.contList=res.data.result;
    }else {
      this.contList=[];
       wx.showToast({
            title: res.data.msg,
            icon: 'none',
            duration: 2000
          });
      // this.$parent.showErrorMsg("错误提示", res.data.msg);
    }
    this.$apply()
  }

  onShow() {
    this.getUserPower();
    this.getUserProduct()
  }
}
</script>
