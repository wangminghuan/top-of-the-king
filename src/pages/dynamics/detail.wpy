<style lang="less">
@import '../../static/style/borderComLine.less';
@import '../../static/style/comAvator.less';
.dynamic-deatail {
  padding: 0 34rpx 34rpx 34rpx;
  color: #fff;
  .ye {
    color: #f1f4ba;
  }
  .msg-title {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0 40rpx;
    font-size: 28rpx;
    height: 118rpx;
  }
  .com-avator {
    margin-right: 30rpx;
  }
  .cont {
    background-color: #4c6b94;
    box-shadow: inset 0 0 24rpx 8rpx #9fa4a9;
    border: 1rpx solid #232b4f;
    .info,
    .status {
      display: flex;
      align-items: center;
    }
    .info {
      height: 170rpx;
      padding: 0 40rpx;
    }
    .info-txt {
      font-size: 30rpx;
      view {
        line-height: 48rpx;
        font-size: 28rpx;
      }
      text {
        line-height: 38rpx;
        font-size: 22rpx;
        color: #c5ddf1;
      }
    }
    .titl {
      font-size: 30rpx;
      text-align: center;
      padding: 30rpx 40rpx 20rpx 40rpx;
      line-height: 50rpx;
    }
    .msg {
      line-height: 30rpx;
      font-size: 24rpx;
      padding: 38rpx 40rpx 0;
    }
    .status {
      // height: 40px;
      padding: 0 40rpx;
      // justify-content: space-between;
      color: #cbe3f7;
      font-size: 24rpx;
      color: #cbe3f7;
      view {
        height: 40px;
        display: flex;
        align-items: center;
      }
      .icon {
        color: #f1f4ba;
        padding-left: 40rpx;
        margin-left: 68rpx;
        // background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAaCAMAAACaYWzBAAAAV1BMVEUAAADx9Lrx9Lrx9Lrx9Lrx9Lrx9Lrx9Lrx9Lrx9Lrx9Lrx9Lrx9Lrx9Lrx9Lrx9Lrx9Lrx9Lrx9Lrx9Lrx9Lrx9Lrx9Lrx9Lrx9Lrx9Lrx9Lrx9Lrx9Lp45tP4AAAAHHRSTlMAPEvhRAr6hfLqy5HV0Luaf1ktEt+ja2dBNC4bf/r0rgAAAIBJREFUKM91z0kOhDAMRFEHyEwz9dzt+5+TJCyQsOsv60lRTGdf7++kZBzzaBWYufRS4FZhkrt1FaKED9eChNxglC/FBl7Awq3tuq+u7XE4MuXSn8/zZvhS6Nr3OwHcU68DIwgIJgQLggGAswASAcgIVgR/AA8C8ETwLpAUSJZoB+O9KHScoGflAAAAAElFTkSuQmCC');
        background-repeat: no-repeat;
        background-size: 24rpx auto;
        background-position-y: center;
        background-position-x: 0;
      }
      .icon.unlike{
        background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAaCAMAAACaYWzBAAAAWlBMVEUAAAD///////////////////////////////////////////////////////////////////////////////////////////////////////////////////9ZMre9AAAAHXRSTlMAPEvhQ/qF8suR6tXQmn9ZLRgOCwfpu7qja2c0LhjJOAkAAAB/SURBVCjPdc5JEoMwDERRGc8QZjJH979msFlQhdR/2W/TdPYNYSYl45m7TYGe994K3Ao85L75Aq0Ex6UoIVfoxL7eKwQBA9em6z76urfuyCxEv5D7yfCl2NT7jQC2ZHVgBBHBE8GAwAHwK4BEADKCEcEMwBKAF4LPDkmBtBD9AVlWKeEhiYqBAAAAAElFTkSuQmCC');
      }
      .icon.like{
         background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAaCAMAAACaYWzBAAAAV1BMVEUAAADx9Lrx9Lrx9Lrx9Lrx9Lrx9Lrx9Lrx9Lrx9Lrx9Lrx9Lrx9Lrx9Lrx9Lrx9Lrx9Lrx9Lrx9Lrx9Lrx9Lrx9Lrx9Lrx9Lrx9Lrx9Lrx9Lrx9Lrx9Lp45tP4AAAAHHRSTlMAPEvhRAr6hfLqy5HV0Luaf1ktEt+ja2dBNC4bf/r0rgAAAIBJREFUKM91z0kOhDAMRFEHyEwz9dzt+5+TJCyQsOsv60lRTGdf7++kZBzzaBWYufRS4FZhkrt1FaKED9eChNxglC/FBl7Awq3tuq+u7XE4MuXSn8/zZvhS6Nr3OwHcU68DIwgIJgQLggGAswASAcgIVgR/AA8C8ETwLpAUSJZoB+O9KHScoGflAAAAAElFTkSuQmCC');
      }
    }
  }
  .item {
    height: 198rpx;
    display: flex;
    align-items: center;
    padding: 0 40rpx;
    .rt {
      flex-shrink: 1;
      display: flex;
      flex-direction: column;
      view {
        line-height: 48rpx;
        font-size: 26rpx;
      }
      text {
        color: #cbe3f7;
        line-height: 30rpx;
        font-size: 20rpx;
        display: -webkit-box;
        -webkit-box-orient: vertical;
        -webkit-line-clamp: 2;
        overflow: hidden;
      }
    }
  }
}
</style>
<template>
  <view class="dynamic-deatail">
    <view class="cont">
      <view class="info border-com-line">
        <view class="com-avator"><image src="{{pageObj.HeadImg}}" mode="scaleToFill" /></view>
        <view class="info-txt">
              <view class="ye">{{pageObj.NickName}}</view>
              <text>{{pageObj.CreateDate}}</text>
        </view>
      </view>
      <view class="titl border-com-line ye" wx:if="{{pageObj.Title}}">{{pageObj.Title}}</view>
      <view class="msg">{{pageObj.Txt}}</view>
      <view class="status">
        <view >评论：{{pageObj.ReviewCount}}</view>
        <view class="icon {{hasClickLike?'like':'unlike'}}" @tap="handleClickLike">点赞：{{pageObj.LikeCount||'0'}}</view>
      </view>
    </view>
    <view class="msg-title border-com-line">
      <text>留言区</text>
     <image @tap="handleJumpAdd" src="../../static/img/dynamics/msg-add.png" mode="aspectFit" style="width:36rpx;height:45rpx;"/>
    </view>
    <scroll-view scroll-y style="height: 560rpx;">
        <repeat for="{{listArr}}" key="index" index="index" item="item">
          <view class="item border-com-line">
            <view class="com-avator"><image src="{{item.HeadImg}}" mode="scaleToFill" /></view>
            <view class="rt" @tap="handleJumpDetail({{item}})">
              <view class="ye">{{item.NickName}}</view>
              <text>{{item.ReviewTxt}}</text>
            </view>
            </view>
        </repeat>
    </scroll-view>
  </view>
</template>

<script>
import wepy from 'wepy';
import wxRequest from '../../util/wxRequest.js';
export default class dynamicDetail extends wepy.page {
  config = {
    navigationBarTitleText: '详情'
  };
  components = {};
  data = {
    postid:0,
    hasClickLike:false,//是否点赞
    pageObj: {},
    listArr:[]
  };

  computed = {
    heroInfo(){
      return  this.$parent.globalData.HeroInfo;
    }
  };

  methods = {
    handleClickLike(){
        if(this.hasClickLike){
          wx.showToast({
          title: '您已经点过赞了',
          icon: 'none',
          duration: 2000
          });
          return;
        }
        this.addPostLike();
      },
    handleJumpAdd() {
      this.$navigate('/pages/my/addMsg?type=3&toId='+this.postid+'&fromId='+this.heroInfo.Id+'&toName='+this.pageObj.NickName);
    },
    handleJumpDetail(item) {
      this.$navigate('/pages/dynamics/leaveMsg?data='+JSON.stringify(item));
    }
  };

  events = {};
  async getPostByID() {
    const that = this;
    const res = await wxRequest(
      {
        query: {
          opt: 'getPostByID',
          postid: that.postid,
        }
      },
      that.$parent.globalData.apiUrl
    );
    if (res.data.retcode == 0) {
      this.pageObj=res.data.result;
    } 
    this.$apply();
  }
  
  async getPostReview() {
    const that = this;
    const res = await wxRequest(
      {
        query: {
          opt: 'getPostReview',
          postid: that.postid,
        }
      },
      that.$parent.globalData.apiUrl
    );
    if (res.data.retcode == 0) {
      this.listArr=res.data.result;
    } 
    this.$apply();
  }
  async checkPostLike() {
      const that = this;
      const res = await wxRequest({
          query: {
            opt: 'checkPostLike',
            postid: that.postid,
            userid:that.heroInfo.Id
          }
        },that.$parent.globalData.apiUrl);
        if (res.data.retcode == 0) {
            this.hasClickLike = true;
        }
        this.$apply();
    }
  //点赞 
    async addPostLike() {
      const that = this;
      const res = await wxRequest({
          query: {
            opt: 'addPostLike',
            postid: that.postid,
            userid:that.heroInfo.Id
          }
        },that.$parent.globalData.apiUrl);
       if (res.data.retcode == 0) {
          wx.showToast({
            title: '点赞成功',
            icon: 'success',
            duration: 2000
          });
          this.hasClickLike=true;
      }else {
        this.$parent.showErrorMsg("错误提示", res.data.msg);
      }
      this.$apply();
    }
  onLoad(params) {
    this.postid=params.id;
    this.getPostByID();//获取帖子
  }
  onShow(){
    this.getPostReview();
    this.checkPostLike()
  }
}
</script>
